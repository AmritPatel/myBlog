---
title: 30 day rope skip challenge.
author: Amrit D. Patel
date: '2020-08-08'
slug: learning-to-rope-skip
categories:
  - exploratory
tags:
  - regression
  - plot
---

Over our recent 5 month stay in Thailand we happened to acquire a jump rope. For most of the time it collected dust. Now that I've picked it up again I'm thinking the reason was because jumping rope is actually pretty challenging. On multiple levels.

There is the whole timing the rope turns in sync with your jumping, which stimulates brain activity and as [crossrope.com](https://www.crossrope.com/blogs/blog/benefits-of-jumping-the-unique-value-of-jump-rope-training-good-cardio/) explains:

> *...helps with the development of the left and right hemispheres of your brain, which further enhances spatial awareness, improves reading skills, increases memory and makes you more mentally alert.*

> *As described in [an] [article from BrainHQ](https://www.brainhq.com/brain-resources/everyday-brain-fitness/physical-exercise), the best exercise for the brain involves a combination of timing, rhythm, coordination, and mental strategy.*

> *When you’re jumping rope, you’re combining timing and rhythm while having to make quick calculations to ensure your brain is recognizing the rope’s distance, speed, direction, and position relative to your body to ensure the rotations keep going. This combination of physical and mental activity has a greater effect on cognitive function.*

Other touted benefits include:

- high efficiency calorie burning
- improved cardio
- increased muscle engagement
- improved bone density

As the [*Jump Rope Institute*](http://www.jumpropeinstitute.com/benefits.htm) says: 

> The benefits of this simple but yet complex training technique ranks as an ideal brain exercise, bone builder, and as one of the most efficient ways of improving cardiovascular fitness ***in as little as ten minutes***.

More impressively, the *Jump Rope Institute* also says that with only 10 minutes of nonstop jumping at 120 jumps per minute (jpm) it can provide the same benefits as:

- 30 minutes of jogging (**!**)
- 2 sets of tennis singles
- 30 minutes of racket/handball playing
- 720 yards of swimming
- 18 holes of golf

What a missed opportunity for some quality fitness training!

## The gear

After the first day of jumping, counting jumps wasn't my favorite part. I started a spreadsheet recording the number of jumps and my max heart rate, and quickly realized that there is likely an even better way to track this data.

I headed over to the  *Garmin Connect IQ Store* and was pleasantly surprised to find the really nice [*Jumps*](https://apps.garmin.com/en-US/apps/539e6c9e-a735-45c6-b390-c0bc65c1d65a) data field that not only counts your total jumps for you, but also gives you jumps over time data, jpm over time data, and a "Jumping Effect" score, which is supposed to be an indicator for how hard you trained with a value of 100 being equivalent to jumping 20 minutes non-stop at a 120+ jpm pace.

I also learned a new unit to describe efficiency of physical exertion: the metabolic equivalent or MET. A MET is defined as *the objective measure of the ratio of the rate at which a person expends energy, relative to the mass of that person, while performing some specific physical activity compared to a reference, set by convention at 3.5 mL of oxygen per kilogram per minute, which is roughly equivalent to the energy expended when sitting quietly*.[^1]

So, you spend 1 MET sitting around playing video games, for example, and a whopping [12.3 METs](https://sites.google.com/site/compendiumofphysicalactivities/Activity-Categories/sports) jumping rope at a pace of 120-160 jpm![^2]

[^1]: From [Wikipedia: Metabolic equivalent of task](https://en.wikipedia.org/wiki/Metabolic_equivalent_of_task).
[^2]: 100 jpm burns 11.8 METs and 80 jpm burns 8.8 METs.

## The setup

Building off of the heat training running posts from this past summer and the utilities built, I realized it would be straightforward to create another automated data pipeline. The basic flow is:

1. Pull raw data from *GarminDb* `bash` script to get *Garmin* .FIT files containing jump rope activity data from the cloud.
2. Run [`fitparse`](https://github.com/dtcooper/python-fitparse) Python script in R via the `reticulate` library to convert binary .FIT to readable ASCII.
3. Post-process ASCII file using `readr::read_csv` to get data into a dataframe, then formatting the data for plotting.


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = "center")
library(reticulate)
virtualenv_create("jumps")
py_install("fitparse", envname = "jumps")
use_virtualenv("jumps")
```

```{r, eval = F}
# py_install("python-fitparse")
# py_config() 
# py_available(initialize = FALSE)
# py_module_available("fitparse")
# conda_list()
# use_condaenv(condaenv = "auto")
```

### Step 1: Get raw data.

```{r, echo = T}
library(DBI)
library(RSQLite)
library(tidyverse)

# Setup a working directory to copy files to for processing.
workDir <- "~/HealthData/FitFiles/working/"
# setwd(workDir)

con <- dbConnect(SQLite(), "/Users/amrit/HealthData/DBs/garmin_activities.db")

# dbListTables(con)

acts <- dbReadTable(con, 'activities')

# Path of the SQLite activities database.
path <- "/Users/amrit/HealthData/FitFiles/Activities/"

# Get .fit filenames based on running activity names.
cardio <-
  acts %>%
  filter(sub_sport == "cardio_training") %>%
  arrange(desc(start_time)) %>%
  # Allow partial activity date matching.
  filter(str_detect(start_time, "2020-")) %>%
  select(start_time, activity_id) %>%
  mutate(activity_id = paste0(path, activity_id, ".fit"))
 
save(cardio, file = "~/HealthData/FitFiles/working/cardio.Rdata")

# Copy .fit files to working directory.
walk(paste("cp", cardio$activity_id, workDir), system) # same as lapply w/ no output printed
```

### Step 2: Convert data from binary to human readable form. 

```{r, echo = T}
getFitOut <- function() {

library(reticulate)
py_capture_output(py_run_string("import fitparse

# Load the FIT file
fitfile = fitparse.FitFile(r.fitFile)

# Iterate over all messages of type \"record\"
# (other types include \"device_info\", \"file_creator\", \"event\", etc)
for record in fitfile.get_messages(\"session\"):

    # Records can contain multiple pieces of data (ex: timestamp, latitude, longitude, etc)
    for data in record:

        # Print the name and value of the data (and the units if it has any)
        if data.units:
            print(\"{}, {}, {}\".format(data.name, data.value, data.units))
        else:
            print(\"{}, {}, NA\".format(data.name, data.value))
"))
}
```

### Step 3: Format data for plotting.

```{r, echo = T}
getJumpData <- function(jumpFit) {

# Run python file created by @mcandocia on GitHub @ https://github.com/mcandocia/examples/tree/master/convert_fit_to_csv 
# to convert .fit data to .csv to allow for processing in R.
  
# source_python("jumps.py", envir = NULL)

jump <- read_csv(jumpFit, col_name = c('type', 'value', 'units'))

jump %>%
  filter(
    type == "unknown_110" |
    type == "Jumping Effect" |
    type == "Jumps" |
    type == "avg_heart_rate" |
    type == "max_heart_rate" |
    type == "avg_temperature" |
    type == "max_temperature" |
    type == "start_time" |
    type == "sub_sport" |
    type == "total_anaerobic_training_effect" |
    type == "total_training_effect" |
    type == "total_calories" |
    type == "total_elapsed_time"
    ) %>%
  select(type, value) %>%
  pivot_wider(names_from = type) %>%
  type_convert(col_types = cols(.default = col_double(),
                                start_time = col_datetime(),
                                sub_sport = col_character(),
                                unknown_110 = col_character()
                                )
               ) %>%
  rename(name = unknown_110,
         jumpingEffect = "Jumping Effect",
         jumps = Jumps
         )
}
```

```{r, echo = T}
passFit <- function() {
  getJumpData(getFitOut())
}

datalist = list()

for (i in 1:length(cardio$activity_id)) {
  fitFile <- cardio$activity_id[i]
  dat <- passFit()
  datalist[[i]] <- dat
}

jumpData <-
  bind_rows(datalist) %>%
  filter(jumps > 0) %>%
  mutate(jpm = jumps / total_elapsed_time * 60)
```

```{r, echo = T}
pltJumpData <- 
  jumpData %>%
  select(-sub_sport, -name) %>%
  pivot_longer(-start_time)

ggplot(pltJumpData, aes(start_time, value)) + 
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~ name, scales = "free_y") +
  labs(title = "Summary of jump rope session data",
       x = "Date",
       y = "Value") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, eval = F}
# ggplot(jumpData, aes(start_time, jpm, color = Hmisc::cut2(jumps, cuts = c(501)))) + 
#   geom_point() +
#   geom_smooth(method = lm, se = FALSE)

# ggplot(jumpData %>% filter(jumps >= 500), aes(jpm, avg_heart_rate, label = jumps)) +
#   geom_point() +
#   geom_text(vjust = 0, nudge_y = 0.3)
```

## The challenge

The natural challenge that I gave myself based on my reading of the above info sources was to jump rope for 30 days straight. *And*, each session should last for at least ~10 minutes (or at least ~1000 jumps).

Below is the plot that I've designed to help me keep track of my daily jump data, while also allowing me to track changes in fitness by observing changes in average heart rate during each jump session over time -- a simple metric that will hopefully serve as a useful measure.[^3]

[^3]: Hoping to see a decreasing trend in average heart rate over time indicating an increase in fitness.

```{r}
library(plotly)

jumpGroup <- Hmisc::cut2(jumpData$jumps, cuts = c(501))

p <-
  ggplot(jumpData, aes(start_time, avg_heart_rate, color = jumpGroup,
                       label  = jumps,
                       label2 = jpm,
                       label3 = max_heart_rate,
                       label4 = total_training_effect,
                       label5 = jumpingEffect
                       )
         ) + 
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  # geom_text(vjust = 0, nudge_y = 1.0) +
  labs(title = "Change in cardio fitness over time from jumping rope",
       subtitle = "Goal is min of 10 min. continuous jumping per session",
       x = "Date",
       y = "Average heart rate (bpm)")

ggplotly(p) %>%
  layout(title = list(text = paste0("Change in cardio fitness over time from jumping rope",
                                    '<br>',
                                    '<sup>',
                                    "Goal is min of 10 min. continuous jumping per session",
                                    '</sup>')))
```

I've separated the data in the plot into 2 groups: one with points with < 500 jumps and one with >= 500 jumps. This is mainly so the regression line for the >= 500 jump group isn't biased low due to sessions with relatively fewer jumps, which would correspond to a much lower average heart rate.