---
title: 100 Lap Challenge
author: Amrit Patel
date: '2020-03-27'
slug: 100-lap-challenge
categories:
  - R
tags:
  - R Markdown
---

## Data prep.

### Define function to re-format data for plotting.

```{r, message = F}
library(tidyverse)

getData <- function(fname, Date) {
  day <- tbl_df(read.csv(fname, stringsAsFactors = F))
  day <- day %>% slice(-n():-n())
  day$Laps <- as.numeric(day$Laps)
  
  day <- day %>% separate(Avg.Pace, c("Avg.Pace.Min", "Avg.Pace.Sec"))
  day$Avg.Pace.Min <- as.numeric(day$Avg.Pace.Min)
  day$Avg.Pace.Sec <- as.numeric(day$Avg.Pace.Sec)
  
  day <- day %>% separate(Time, c("Time.Min", "Time.Sec"))
  day$Time.Min <- as.numeric(day$Time.Min)
  day$Time.Sec <- as.numeric(day$Time.Sec)
  
  day <- 
    day %>% 
    mutate(Distance = 0.075) %>%
    select(Laps,
           Time.Min,
           Time.Sec,
           Distance,
           Avg.HR,
           Max.HR,
           Cadence = Avg.Run.Cadence,
           Kcals = Calories,
           Temp = Avg.Temperature,
           )
}
```

### Day 1.

Fix laps where I forgot to hit the "lap" button (i.e., combined splits).

```{r, warning = F}
day1 <- getData("~/Downloads/Vadhana Running - 2020-03-24.csv") %>% mutate(Date = "2020-03-24")

day1.1 <- day1 %>% slice(1:9)
day1.2 <- day1 %>% slice(10)

day1.2 <- 
  bind_rows(day1.2, day1.2) %>%
  mutate(Time.Sec = Time.Min * 60 / 2 + Time.Sec / 2, Time.Min = 0, Kcals = Kcals / 2)

day1.2$Laps[2] <- 11

day1.3 <- 
  day1 %>%
  slice(11:n()) %>%
  mutate(Laps = Laps + 1)

day1 <- bind_rows(day1.1, day1.2, day1.3)
```

Correct average pace based on more accurate estimate of lap distance.

```{r}
day1 <- 
  day1 %>%
  mutate(Avg.Pace = Time.Sec / 60 / Distance) %>%
  select(-Time.Min) %>% rename(Time = Time.Sec)
```

### Day 2.

Again, fix laps where I forgot to hit the "lap" button (i.e., combined splits).

```{r, warning = F}
day2 <- getData("~/Downloads/Vadhana Running - 2020-03-25.csv") %>% mutate(Date = "2020-03-25")

day2.1 <- day2 %>% slice(1:31)
day2.2 <- day2 %>% slice(32)

day2.2 <- 
  bind_rows(day2.2, day2.2) %>%
  mutate(Time.Sec = Time.Min * 60 / 2 + Time.Sec / 2, Time.Min = 0, Kcals = Kcals / 2)

day2.2$Laps[2] <- 33

day2.3 <- 
  day2 %>%
  slice(33:n()) %>%
  mutate(Laps = Laps + 1)

day2 <- bind_rows(day2.1, day2.2, day2.3)
```

Correct average pace based on more accurate estimate of lap distance.

```{r}
day2 <- 
  day2 %>%
  mutate(Avg.Pace = Time.Sec / 60 / Distance) %>%
  select(-Time.Min) %>% rename(Time = Time.Sec)
```

### Day 3.

```{r, warning = F}
day3 <- getData("~/Downloads/Vadhana Running - 2020-03-27.csv") %>% mutate(Date = "2020-03-27")

day3 <- 
  day3 %>%
  mutate(Avg.Pace = Time.Sec / 60 / Distance) %>%
  select(-Time.Min) %>% rename(Time = Time.Sec)
```

## Exploratory data analysis.

```{r, message = F}
library(reshape2)

runData <- bind_rows(day1, day2, day3)

# Total Beats = (Average Heart Rate – Resting Heart Rate) * Time in Minutes
RHR <- 60
# Work Per Mile = Total Beats / Distance in Miles
# Efficiency = 1 / Work Per Mile * 100,000

# Determine RPI (from: https://fellrnr.com/wiki/Running_Economy)
runData <- runData %>% mutate(RPI = 1 / (((Avg.HR - RHR) * (Time / 60)) / Distance) * 100000)

runData$Date <- as.Date(runData$Date)

pltRunData <- melt(runData, id.vars = c("Date", "Laps")) %>% filter(variable != "Distance")

meanData <- pltRunData %>%
  group_by(Date, variable) %>%
  summarize(avg = mean(value)) %>%
  left_join(pltRunData %>% group_by(variable) %>%
  summarize(ypos = 0.95*max(value))) %>%
  filter(variable != "Distance")

ggplot(pltRunData, aes(x=Laps, y=value)) +
  geom_hline(data=meanData, aes(yintercept = avg), colour="red", lty=3) +
  geom_text(data=meanData,
            aes(label=round(avg,1), x=62, y=ypos),
            colour="red",
            hjust=1,
            size=3) +
  xlim(c(1,65)) +
  geom_line() + 
  facet_grid(variable ~ Date, scales = "free_y") 
```

```{r}
lessPlt <- pltRunData %>% filter(variable == "Avg.HR" |
                                 variable == "Avg.Pace" |
                                 variable == "Cadence" |
                                 variable == "Temp" |
                                 variable == "RPI"   
                                )

lessMean <- meanData %>% filter(variable == "Avg.HR" |
                                variable == "Avg.Pace" |
                                variable == "Cadence" |
                                variable == "Temp" |
                                variable == "RPI"
                               ) 

ggplot(lessPlt, aes(x=Laps, y=value)) +
  geom_hline(data=lessMean, aes(yintercept = avg), colour="red", lty=3) +
  geom_text(data=lessMean,
            aes(label=round(avg,1), x=62, y=ypos),
            colour="red",
            hjust=1,
            size=3) +
  xlim(c(1,65)) +
  geom_line() + 
  facet_grid(variable ~ Date, scales = "free_y") 
```

```{r}
lessPlt$Date <- as.factor(lessPlt$Date)

ggplot(lessPlt, aes(x=Laps, y=value, color=Date)) +
  xlim(c(1,65)) +
  geom_line() +  
  facet_grid(variable ~ ., scales = "free_y") 
```

There seems to be a relationship between cadence and RPI, cadence and pace, and heart rate and temperature!

```{r}
dayData <- meanData %>% filter(variable != "Max.HR", variable != "Time", variable != "Kcals")

ggplot(dayData, aes(avg, fill = variable)) +
  geom_bar() +
  facet_grid(Date ~ variable, scales = "free")
```

```{r}
ggplot(dayData, aes(avg, fill=variable)) +
  geom_bar() +
  facet_grid(Date ~ variable, scales = "free") +
  theme(legend.position="none")
```

```{r}
ggplot(dayData, aes(Date, avg, color = variable)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free") +
  theme(legend.position="none")
```

```{r, warning = F, message = F}
ggplot(dayData, aes(Date, avg, color = variable)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free") +
  geom_smooth() +
  theme(legend.position="none")
```

```{r}
ggplot(dayData, aes(Date, avg, color = variable)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free") +
  geom_smooth(method = lm, se = TRUE) +
  theme(legend.position="none")
```

So, in short, slow down, and increase the cadence -- especially as the outside tempeature increases! When this happens, average heart rate decreases, you can delay the onset of fatigue, and run longer!

```{r}
ggplot(dayData, aes(Date, avg, color = variable)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free") +
  geom_smooth(method = lm, se = FALSE) +
  theme(legend.position="none")
```

## Running economy over time.

```{r}
historical <- tbl_df(read.csv("~/Downloads/Vadhana Running - Historical.csv", stringsAsFactors = F))

rpi <- 
  historical %>%
    filter(Activity.Type == "Running") %>%
    select(Date, Title, Distance, Kcals = Calories, Time, Avg.HR, Cadence = Avg.Run.Cadence, Avg.Pace, Elev.Gain, Elev.Loss, Temp = Min.Temp)

rpi <- rpi[-c(4), ]

rpi$Date <- as.Date(rpi$Date)

rpi <- rpi %>% separate(Avg.Pace, c("Avg.Pace.Min", "Avg.Pace.Sec"))
rpi$Avg.Pace.Min <- as.numeric(rpi$Avg.Pace.Min)
rpi$Avg.Pace.Sec <- as.numeric(rpi$Avg.Pace.Sec)
  
rpi <- rpi %>% separate(Time, c("Time.Hour", "Time.Min", "Time.Sec"))
rpi$Time.Hour <- as.numeric(rpi$Time.Hour)
rpi$Time.Min <- as.numeric(rpi$Time.Min)
rpi$Time.Sec <- as.numeric(rpi$Time.Sec)

# Total Beats = (Average Heart Rate – Resting Heart Rate) * Time in Minutes
RHR <- 60
# Work Per Mile = Total Beats / Distance in Miles
# Efficiency = 1 / Work Per Mile * 100,000

# Determine RPI (from: https://fellrnr.com/wiki/Running_Economy)
rpi <- rpi %>% mutate(Time = Time.Hour * 3600 + Time.Min * 60 + Time.Sec,
                      RPI = 1 / (((Avg.HR - RHR) * (Time / 60)) / Distance) * 100000)
```
```{r}
library(plotly)
p <- 
  ggplot(rpi, aes(Date, RPI, color = Temp,
                  label = Title,
                  label2 = Distance,
                  label3 = Avg.HR,
                  label4 = Cadence)) +
    geom_point() +
    geom_smooth(method = lm) # formula = y ~ splines::bs(x, 3)

ggplotly(p)
```



